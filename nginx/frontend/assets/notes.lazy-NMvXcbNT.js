import{c as de,x as V,u as I,a as z,r as x,b as F,y as k,j as e,D as ue,d as xe,e as me,I as Z,f as he,h as ge,B as S,i as q,A as pe,k as fe,l as je,m as ve,n as Ne,o as ye,p as we,q as be,z as Ce,E as Se,H as Te,s as ke,t as De,T as U,C as Fe,v as _e,F as Pe,S as Ee,P as Me,X as W,G as qe,J as Ke,N as Ae,w as Qe}from"./index-QCM3tg6T.js";import{M as Ve}from"./main-BjTc0OpD.js";import{u as Ie,a as ze}from"./use-infinite-scroll-Hevnk5Sy.js";import{N as ee}from"./NoteEditor-CprC5Dzg.js";import{P as Re}from"./pencil-DNI9aBCu.js";import{f as X,g as He,V as Oe,s as Le}from"./notes-view-storage-BL2JrqSo.js";import{T as Be,a as $e,b as Y,c as E,d as Ge,e as M}from"./table-KDMBuP_H.js";import{M as se}from"./markdown-text-BgLqbmVy.js";import{E as Je}from"./eye-5ZjLGcoG.js";import"./save-B-fZiOhd.js";import"./setPrototypeOf-BNw_nwy-.js";import"./copy-CJ7BnBjG.js";/**
 * @license lucide-react v0.468.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const We=de("Maximize2",[["polyline",{points:"15 3 21 3 21 9",key:"mznyad"}],["polyline",{points:"9 21 3 21 3 15",key:"1avn1i"}],["line",{x1:"21",x2:"14",y1:"3",y2:"10",key:"ota7mn"}],["line",{x1:"3",x2:"10",y1:"21",y2:"14",key:"1atl0r"}]]);function Xe({open:r,onOpenChange:t,note:s,onFullscreenEdit:u}){const{t:i}=V(),l=I(),{toast:n}=z(),[p,m]=x.useState(!1),f=x.useRef(null),[y,T]=x.useState(!1),[w,C]=x.useState((s==null?void 0:s.title)||""),b=x.useRef(null);x.useEffect(()=>{C((s==null?void 0:s.title)||"")},[s==null?void 0:s.title]);const h=F({mutationFn:k.create,onSuccess:o=>{l.invalidateQueries({predicate:a=>{const g=a.queryKey[0];return g==="notes"||g==="notes-infinite"}}),o.tag_details&&o.tag_details.some(a=>a.is_new)&&(console.log("ðŸ·ï¸ æ£€æµ‹åˆ°æ–°æ ‡ç­¾,åˆ·æ–°æ ‡ç­¾æ ‘:",o.tag_details.filter(a=>a.is_new)),l.invalidateQueries({queryKey:["note-tags-tree"]})),m(!1),n({title:"ä¿å­˜æˆåŠŸ",description:"ç¬”è®°å·²æˆåŠŸä¿å­˜"})},onError:()=>{m(!1),n({title:"ä¿å­˜å¤±è´¥",description:"ç¬”è®°ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•",variant:"destructive"})}}),c=F({mutationFn:({uuid:o,data:a})=>k.update(o,a),onSuccess:o=>{l.invalidateQueries({predicate:a=>{const g=a.queryKey[0];return g==="notes"||g==="notes-infinite"}}),o.tag_details&&o.tag_details.some(a=>a.is_new)&&(console.log("ðŸ·ï¸ æ£€æµ‹åˆ°æ–°æ ‡ç­¾,åˆ·æ–°æ ‡ç­¾æ ‘:",o.tag_details.filter(a=>a.is_new)),l.invalidateQueries({queryKey:["note-tags-tree"]})),m(!1),n({title:"ä¿å­˜æˆåŠŸ",description:"ç¬”è®°å·²æˆåŠŸä¿å­˜"})},onError:()=>{m(!1),n({title:"ä¿å­˜å¤±è´¥",description:"ç¬”è®°ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•",variant:"destructive"})}}),v=(o,a)=>{o.trim()&&(m(!0),s?c.mutate({uuid:s.uuid,data:{title:(a==null?void 0:a.trim())||"",content:o.trim()}}):h.mutate({title:(a==null?void 0:a.trim())||"",content:o.trim(),status:1}))},_=()=>{T(!0),setTimeout(()=>{var o,a;(o=b.current)==null||o.focus(),(a=b.current)==null||a.select()},0)},K=()=>{T(!1)},A=o=>{var a;o.key==="Enter"&&(o.preventDefault(),(a=b.current)==null||a.blur())},P=()=>{var g,j;const o=((j=(g=f.current)==null?void 0:g.getContent)==null?void 0:j.call(g))||"",a=w||"";t(!1),u&&u(s,o,a)};return e.jsx(ue,{open:r,onOpenChange:t,children:e.jsxs(xe,{className:"sm:max-w-[600px] h-[500px] flex flex-col",children:[e.jsx(me,{children:e.jsx("div",{className:"flex items-center space-x-2",children:y?e.jsx(Z,{ref:b,value:w,onChange:o=>C(o.target.value),onBlur:K,onKeyDown:A,className:"text-sm font-semibold h-6 max-w-xs border-0 shadow-none focus-visible:ring-0 px-1",placeholder:"è¯·è¾“å…¥æ ‡é¢˜"}):e.jsxs("div",{className:"flex items-center space-x-2 group cursor-pointer min-w-0",onClick:_,children:[e.jsx(he,{className:"truncate max-w-md",children:w||i(s?"notes.editNote":"notes.createNote")}),e.jsx(Re,{className:"h-4 w-4 text-muted-foreground flex-shrink-0"})]})})}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(ee,{ref:f,note:s,onSave:v,isSaving:p,showToolbar:!1,editorId:"dialog-editor",className:"h-full",vditorToolbar:"simple"})}),e.jsx(ge,{children:e.jsxs("div",{className:"flex items-center justify-between w-full",children:[e.jsxs(S,{variant:"ghost",onClick:P,disabled:p,className:"flex items-center gap-2",children:[e.jsx(We,{className:"h-4 w-4"}),i("notes.fullscreenEdit")]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(S,{variant:"outline",onClick:()=>t(!1),disabled:p,children:"å…³é—­"}),e.jsxs(S,{onClick:()=>{var a,g;const o=((g=(a=f.current)==null?void 0:a.getContent)==null?void 0:g.call(a))||"";v(o,w)},disabled:p,children:[p&&e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),i("common.save")]})]})]})})]})})}function Ye({open:r,onOpenChange:t,note:s}){V();const u=I(),{toast:i}=z(),l=F({mutationFn:m=>k.delete(m),onSuccess:()=>{u.invalidateQueries({queryKey:["notes"]}),t(!1),i({title:"åˆ é™¤æˆåŠŸ",description:"ç¬”è®°å·²æˆåŠŸåˆ é™¤"})},onError:m=>{i({title:"åˆ é™¤å¤±è´¥",description:(m==null?void 0:m.message)||"åˆ é™¤ç¬”è®°æ—¶å‘ç”Ÿé”™è¯¯",variant:"destructive"})}}),n=()=>{s&&l.mutate(s.uuid)},p=l.isPending;return e.jsx(pe,{open:r,onOpenChange:t,children:e.jsxs(fe,{children:[e.jsxs(je,{children:[e.jsx(ve,{children:"ç¡®è®¤åˆ é™¤"}),e.jsxs(Ne,{children:['æ‚¨ç¡®å®šè¦åˆ é™¤ç¬”è®° "',(s==null?void 0:s.title)||"æ— æ ‡é¢˜",'" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚']})]}),e.jsxs(ye,{children:[e.jsx(we,{disabled:p,children:"å–æ¶ˆ"}),e.jsxs(be,{onClick:n,disabled:p,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:[p&&e.jsx(q,{className:"mr-2 h-4 w-4 animate-spin"}),"åˆ é™¤"]})]})]})})}function Ze({noteId:r,initialContent:t,initialTitle:s,onClose:u}){const i=I(),l=Ce(),{toast:n}=z(),[p,m]=x.useState(!1),{data:f}=Se({queryKey:["note",r],queryFn:()=>k.getDetail(r),enabled:!!r}),y=t&&f?{...f,content:t,title:s||f.title}:t&&!r?{content:t,title:s||""}:f&&s?{...f,title:s}:f,T=F({mutationFn:k.create,onSuccess:h=>{i.invalidateQueries({predicate:c=>{const v=c.queryKey[0];return v==="notes"||v==="notes-infinite"}}),h.tag_details&&h.tag_details.some(c=>c.is_new)&&(console.log("ðŸ·ï¸ æ£€æµ‹åˆ°æ–°æ ‡ç­¾,åˆ·æ–°æ ‡ç­¾æ ‘:",h.tag_details.filter(c=>c.is_new)),i.invalidateQueries({queryKey:["note-tags-tree"]})),m(!1),n({title:"ä¿å­˜æˆåŠŸ",description:"ç¬”è®°å·²æˆåŠŸä¿å­˜"})},onError:()=>{m(!1),n({title:"ä¿å­˜å¤±è´¥",description:"ç¬”è®°ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•",variant:"destructive"})}}),w=F({mutationFn:({uuid:h,data:c})=>k.update(h,c),onSuccess:h=>{i.invalidateQueries({predicate:c=>{const v=c.queryKey[0];return v==="notes"||v==="notes-infinite"}}),h.tag_details&&h.tag_details.some(c=>c.is_new)&&(console.log("ðŸ·ï¸ æ£€æµ‹åˆ°æ–°æ ‡ç­¾,åˆ·æ–°æ ‡ç­¾æ ‘:",h.tag_details.filter(c=>c.is_new)),i.invalidateQueries({queryKey:["note-tags-tree"]})),m(!1),n({title:"ä¿å­˜æˆåŠŸ",description:"ç¬”è®°å·²æˆåŠŸä¿å­˜"})},onError:()=>{m(!1),n({title:"ä¿å­˜å¤±è´¥",description:"ç¬”è®°ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•",variant:"destructive"})}}),C=(h,c)=>{h.trim()&&(m(!0),y?w.mutate({uuid:y.uuid,data:{title:(c==null?void 0:c.trim())||"",content:h.trim()}}):T.mutate({title:(c==null?void 0:c.trim())||"",content:h.trim(),status:1}))},b=()=>{u?u():l({to:"/notes"})};return e.jsx("div",{className:"fixed inset-0 z-50 bg-background",children:e.jsx(ee,{note:y,onClose:b,onSave:C,isSaving:p,editorId:"fullscreen-editor",className:"h-full"})})}function te({note:r,onNoteViewClick:t,children:s}){return e.jsxs(Te,{children:[e.jsx(ke,{asChild:!0,children:s||e.jsx(S,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0",onClick:u=>{u.stopPropagation(),t&&t(r)},children:e.jsx(Je,{className:"h-4 w-4"})})}),e.jsx(De,{className:"w-80 max-h-96 overflow-y-auto",side:"left",children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:r.title}),r.content&&e.jsx("div",{className:"text-sm text-gray-700",children:e.jsx(se,{children:r.content})}),e.jsxs("div",{className:"text-xs text-gray-500 pt-2 border-t",children:["åˆ›å»ºæ—¶é—´: ",new Date(r.created_at).toLocaleString()]})]})})]})}function Ue({notes:r,onNoteTitleClick:t,onNoteViewClick:s,onDeleteNote:u}){const i=l=>{if(l.title&&l.title.trim())return l.title;if(l.content){const n=l.content.replace(/#{1,6}\s+/g,"").replace(/\*\*(.*?)\*\*/g,"$1").replace(/\*(.*?)\*/g,"$1").replace(/`(.*?)`/g,"$1").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/!\[([^\]]*)\]\([^)]+\)/g,"").replace(/\n+/g," ").trim();return n.length>100?n.substring(0,100)+"...":n}return"æ— æ ‡é¢˜"};return e.jsx("div",{className:"w-full",children:e.jsxs(Be,{children:[e.jsx($e,{children:e.jsxs(Y,{children:[e.jsx(E,{children:"æ ‡é¢˜"}),e.jsx(E,{className:"w-[10%] text-center min-w-[80px]",children:"æ›´æ–°"}),e.jsx(E,{className:"w-[10%] text-center min-w-[80px]",children:"åˆ›å»º"}),e.jsx(E,{className:"w-[5%] text-center min-w-[60px]"})]})}),e.jsx(Ge,{children:r.map(l=>e.jsxs(Y,{className:"cursor-pointer hover:bg-muted/50 group",onClick:()=>{t&&t(l)},children:[e.jsx(M,{className:"w-[75%] min-w-[240px]",children:e.jsx("div",{className:"line-clamp-2 text-sm text-foreground/90 hover:text-primary cursor-pointer",onClick:n=>{n.stopPropagation(),t&&t(l)},children:i(l)})}),e.jsx(M,{className:"text-sm text-muted-foreground w-[10%] text-center min-w-[80px] whitespace-nowrap",onClick:n=>n.stopPropagation(),children:X(l.updated_at)}),e.jsx(M,{className:"text-sm text-muted-foreground w-[10%] text-center min-w-[80px] whitespace-nowrap",onClick:n=>n.stopPropagation(),children:X(l.created_at)}),e.jsx(M,{className:"w-[5%] min-w-[60px]",onClick:n=>n.stopPropagation(),children:e.jsxs("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex items-center gap-1",children:[e.jsx(te,{note:l,onNoteViewClick:s}),e.jsx(S,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:n=>{n.stopPropagation(),u&&u(l)},children:e.jsx(U,{className:"h-4 w-4"})})]})})]},l.uuid))})]})})}function es({note:r,onNoteTitleClick:t,onNoteViewClick:s,onDeleteNote:u}){return e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(te,{note:r,onNoteViewClick:s}),e.jsx(S,{variant:"ghost",size:"sm",className:"h-8 w-8 p-0 text-destructive hover:text-destructive hover:bg-destructive/10",onClick:i=>{i.stopPropagation(),u&&u(r)},children:e.jsx(U,{className:"h-4 w-4"})})]})}function ss({notes:r,onNoteTitleClick:t,onNoteViewClick:s,onDeleteNote:u}){return e.jsx("div",{className:"grid gap-3 grid-cols-5",children:r.map(i=>e.jsxs(Fe,{className:"group cursor-pointer hover:shadow-md transition-all duration-200 hover:border-gray-300 flex flex-col h-[180px] bg-white border border-gray-200 rounded-lg relative",onClick:()=>{t&&t(i)},children:[e.jsx("div",{className:"absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity z-10",children:e.jsx(es,{note:i,onNoteTitleClick:t,onNoteViewClick:s,onDeleteNote:u})}),e.jsxs(_e,{className:"p-4 flex-1 overflow-hidden",children:[e.jsx("h3",{className:"font-medium text-sm mb-2 line-clamp-2 text-gray-900 hover:text-primary cursor-pointer",onClick:l=>{l.stopPropagation(),t&&t(i)},children:i.title}),i.content&&e.jsx("div",{className:"text-xs text-gray-600",children:e.jsx("div",{style:{transform:"scale(0.70)",transformOrigin:"top left",width:"145%"},children:e.jsx(se,{children:i.content})})}),e.jsx("div",{className:"text-xs text-gray-400 mt-2",children:new Date(i.created_at).toLocaleDateString()})]})]},i.uuid))})}function ts(r,t){const[s,u]=x.useState(r);return x.useEffect(()=>{const i=setTimeout(()=>{u(r)},t);return()=>{clearTimeout(i)}},[r,t]),s}function as(){var J;const{t:r}=V(),{tagPath:t,setTagPath:s}=Pe(),[u,i]=x.useState(""),[l,n]=x.useState(!1),[p,m]=x.useState(!1),[f,y]=x.useState(null),[T,w]=x.useState(!1),[C,b]=x.useState(null),[h,c]=x.useState(""),[v,_]=x.useState(""),[K,A]=x.useState(null),[P,o]=x.useState("card"),[a,g]=x.useState(0),j=ts(u,500);x.useEffect(()=>{const d=He("card");o(d)},[]);const ae=d=>{o(d),Le(d)},{data:N,isLoading:R,fetchNextPage:H,hasNextPage:O,isFetchingNextPage:L}=Ie({queryKey:["notes-infinite",j,t],queryFn:({pageParam:d=1})=>Ke({pageParam:d,keyword:j,tagPath:t}),initialPageParam:1,getNextPageParam:(d,Q)=>{if(d.data.length===Ae)return Q.length+1},staleTime:0,refetchOnMount:!0,refetchOnWindowFocus:!0}),D=x.useMemo(()=>(N==null?void 0:N.pages.flatMap(d=>d.data))||[],[N]),{loadMoreRef:ne}=ze({hasNextPage:O,isFetchingNextPage:L,fetchNextPage:H,threshold:200}),ie=()=>{g(window.scrollY),y(null),n(!0)},B=d=>{y(d),n(!0)},$=d=>{y(d),n(!0)},re=(d,Q,ce)=>{b(d||null),c(Q||""),_(ce||""),w(!0)},le=()=>{w(!1),b(null),c(""),_("")},G=d=>{A(d),m(!0)},oe=d=>{n(d),d||setTimeout(()=>{window.scrollTo(0,a)},100)};return e.jsxs(e.Fragment,{children:[e.jsxs(Ve,{className:"h-screen",children:[e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsx("div",{className:"flex-shrink-0 border-b bg-background",children:e.jsxs("div",{className:"flex items-center justify-between px-6 py-4",children:[e.jsx("h3",{className:"text-2xl font-bold",children:"ç¬”è®°"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ee,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(Z,{placeholder:r("notes.searchPlaceholder"),value:u,onChange:d=>i(d.target.value),className:"pl-8 h-8 w-48 bg-transparent text-sm"})]}),e.jsx(Oe,{currentView:P,onViewChange:ae}),e.jsxs(S,{onClick:ie,variant:"ghost",children:[e.jsx(Me,{className:"h-4 w-4"}),"æ–°å»ºç¬”è®°"]})]})]})}),e.jsx("div",{className:"flex-1 overflow-auto",children:e.jsxs("div",{className:"max-w-7xl mx-auto pt-0 px-6 pt-6 pb-6",children:[!R&&((J=N==null?void 0:N.pages)==null?void 0:J[0])&&e.jsx("div",{className:"mb-6 text-sm text-muted-foreground flex items-center gap-3",children:N.pages[0].count>0?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:j?e.jsxs(e.Fragment,{children:["æ‰¾åˆ° ",N.pages[0].count,' ä¸ªåŒ¹é… "',j,'" çš„ç¬”è®°']}):e.jsxs(e.Fragment,{children:["å…± ",N.pages[0].count," ä¸ªç¬”è®°"]})}),t&&e.jsxs("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-blue-50 text-blue-700 rounded-md border border-blue-200",children:[e.jsx("span",{className:"text-xs",children:t}),e.jsx("button",{onClick:()=>s(""),className:"hover:bg-blue-100 rounded-full p-0.5 transition-colors",title:"æ¸…é™¤æ ‡ç­¾ç­›é€‰",children:e.jsx(W,{className:"h-3 w-3"})})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("span",{children:j||t?e.jsx(e.Fragment,{children:"æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç¬”è®°"}):e.jsx(e.Fragment,{children:"å…± 0 ä¸ªç¬”è®°"})}),t&&e.jsxs("div",{className:"inline-flex items-center gap-1.5 px-2.5 py-1 bg-blue-50 text-blue-700 rounded-md border border-blue-200",children:[e.jsx("span",{className:"text-xs",children:t}),e.jsx("button",{onClick:()=>s(""),className:"hover:bg-blue-100 rounded-full p-0.5 transition-colors",title:"æ¸…é™¤æ ‡ç­¾ç­›é€‰",children:e.jsx(W,{className:"h-3 w-3"})})]})]})}),R&&D.length===0?e.jsx("div",{className:"flex items-center justify-center py-20",children:e.jsx(q,{className:"h-8 w-8 animate-spin text-gray-400"})}):D.length===0?e.jsxs("div",{className:"flex flex-col items-center justify-center py-20 text-gray-400",children:[e.jsx(qe,{className:"h-12 w-12 mb-2"}),e.jsx("p",{className:"text-sm",children:j?`æ²¡æœ‰æ‰¾åˆ°åŒ¹é… "${j}" çš„ç¬”è®°`:r("notes.noNotes")})]}):e.jsxs(e.Fragment,{children:[P==="card"?e.jsx(ss,{notes:D,onNoteTitleClick:B,onNoteViewClick:$,onDeleteNote:G}):e.jsx(Ue,{notes:D,onNoteTitleClick:B,onNoteViewClick:$,onDeleteNote:G}),e.jsx("div",{ref:ne,className:"mt-8 flex justify-center",children:L?e.jsxs("div",{className:"flex items-center gap-2 py-4",children:[e.jsx(q,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"åŠ è½½æ›´å¤š..."})]}):O?e.jsx("div",{className:"py-4",children:e.jsx(S,{variant:"outline",onClick:()=>H(),className:"text-sm",children:j?"ç‚¹å‡»åŠ è½½æ›´å¤šæœç´¢ç»“æžœ":"ç‚¹å‡»åŠ è½½æ›´å¤š"})}):D.length>0?e.jsx("div",{className:"py-4 text-center",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:"å·²åˆ°åº•å•¦"})}):null})]})]})})]}),e.jsx(Xe,{open:l,onOpenChange:oe,note:f,onFullscreenEdit:re}),e.jsx(Ye,{open:p,onOpenChange:m,note:K})]}),T&&e.jsx(Ze,{noteId:C==null?void 0:C.uuid,initialContent:h,initialTitle:v,onClose:le})]})}const ps=Qe("/_authenticated_notes/notes")({component:as});export{ps as Route};
