import{r as c,u as $,b as f,ap as g,aH as h}from"./index-CTPVv2qI.js";import{u as q,a as F}from"./use-infinite-scroll-BdHXd_Cp.js";const b=9,N=async({pageParam:e=1,keyword:n})=>{const s={page:e,rows:b,...(n==null?void 0:n.trim())&&{keyword:n.trim()}},{data:i}=await g.post("/agent/page",s);return{data:i.items,count:i.pagination.total}},G=async e=>{const{data:n}=await g.post(`/agent/detail/${e}`);return n};function I(e,n){const[s,i]=c.useState(e);return c.useEffect(()=>{const a=setTimeout(()=>{i(e)},n);return()=>{clearTimeout(a)}},[e,n]),s}function T(){var C;const[e,n]=c.useState(""),s=I(e,500),[i,a]=c.useState({type:null}),l=$(),{data:o,isLoading:p,error:m,fetchNextPage:d,hasNextPage:r,isFetchingNextPage:A}=q({queryKey:["agents-infinite",s],queryFn:({pageParam:t=1})=>N({pageParam:t,keyword:s}),initialPageParam:1,getNextPageParam:(t,u)=>{if(t.data.length===b)return u.length+1},staleTime:5*60*1e3}),M=c.useMemo(()=>(o==null?void 0:o.pages.flatMap(t=>t.data))||[],[o]),{loadMoreRef:x}=F({hasNextPage:r,isFetchingNextPage:A,fetchNextPage:d,threshold:200}),y=c.useCallback(()=>{l.invalidateQueries({queryKey:["agents-infinite"]})},[l]),S=f({mutationFn:t=>g.post("/agent/create",t).then(u=>u.data),onSuccess:t=>{h({title:"创建成功",description:`智能体 "${t.name}" 已创建`}),y(),a({type:null})}}),D=f({mutationFn:({uuid:t,data:u})=>g.post(`/agent/update/${t}`,u).then(Q=>Q.data),onSuccess:t=>{h({title:"更新成功",description:`智能体 "${t.name}" 已更新`}),y(),a({type:null})}}),P=f({mutationFn:t=>g.post(`/agent/delete/${t.uuid}`).then(u=>u.data),onSuccess:(t,u)=>{h({title:"删除成功",description:`智能体 "${u.name}" 已删除`}),y(),a({type:null})}}),E=c.useMemo(()=>({create:()=>a({type:"create"}),edit:t=>a({type:"edit",agent:t}),delete:t=>a({type:"delete",agent:t}),close:()=>a({type:null})}),[]);return{agents:M,totalCount:((C=o==null?void 0:o.pages[0])==null?void 0:C.count)||0,isLoadingData:p,isCreating:S.isPending,isUpdating:D.isPending,isDeleting:P.isPending,error:m,hasNextPage:r,isFetchingNextPage:A,fetchNextPage:d,searchQuery:e,setSearchQuery:n,dialogState:i,dialogActions:E,createAgent:S.mutate,updateAgent:D.mutate,deleteAgent:P.mutate,loadMoreRef:x}}function K(){const{dialogState:e,dialogActions:n,createAgent:s,updateAgent:i,deleteAgent:a,isCreating:l,isUpdating:o,isDeleting:p}=T(),m=c.useCallback(r=>{e.type==="create"?s(r):e.type==="edit"&&e.agent&&i({uuid:e.agent.uuid,data:r})},[e.type,e.agent,s,i]),d=c.useCallback(()=>{e.agent&&a(e.agent)},[e.agent,a]);return{open:e.type,currentAgent:e.agent,isLoading:l||o||p,openCreate:n.create,openEdit:n.edit,openDelete:n.delete,closeDialog:n.close,handleSubmit:m,handleDelete:d}}export{K as a,G as g,T as u};
