import{r as u,u as _,b as M,ad as k,at as B,z as R,j as e,S as $,I as q,B as x,X as A,i as F,be as O,T as K,w as V}from"./index-QCM3tg6T.js";import{H as G}from"./header-BrQ_ZiF7.js";import{M as W}from"./main-BjTc0OpD.js";import{u as X,a as Y}from"./use-infinite-scroll-Hevnk5Sy.js";import{C as Z}from"./circle-check-big-OsbAB31v.js";const H=10,J=async({pageParam:n=1,keyword:t})=>{const o={page:n,rows:H,...(t==null?void 0:t.trim())&&{keyword:t.trim()}},{data:i}=await k.post("/chat/conversation/page",o);return{data:i.items,count:i.pagination.total}};function U(n,t){const[o,i]=u.useState(n);return u.useEffect(()=>{const l=setTimeout(()=>{i(n)},t);return()=>{clearTimeout(l)}},[n,t]),o}function L(){var y;const[n,t]=u.useState(""),o=U(n,500),[i,l]=u.useState({type:null}),S=_(),{data:c,isLoading:C,error:b,fetchNextPage:g,hasNextPage:p,isFetchingNextPage:f}=X({queryKey:["historyConversations-infinite",o],queryFn:({pageParam:a=1})=>J({pageParam:a,keyword:o}),initialPageParam:1,getNextPageParam:(a,r)=>{if(a.data.length===H)return r.length+1},staleTime:0,refetchOnMount:!0,refetchOnWindowFocus:!0});u.useEffect(()=>{},[]);const w=u.useMemo(()=>(c==null?void 0:c.pages.flatMap(a=>a.data))||[],[c]),{loadMoreRef:D}=Y({hasNextPage:p,isFetchingNextPage:f,fetchNextPage:g,threshold:200}),v=()=>{S.invalidateQueries({queryKey:["historyConversations-infinite"]})},j=M({mutationFn:a=>k.post(`/chat/conversation/delete/${a.uuid}`).then(r=>r.data),onSuccess:(a,r)=>{B({title:"删除成功",description:`对话 "${r.title}" 已删除`}),v(),l({type:null})}}),d=M({mutationFn:a=>k.post("/chat/conversation/batch_delete",a.map(r=>r.uuid)).then(r=>r.data),onSuccess:(a,r)=>{B({title:"删除成功",description:`已删除 ${r.length} 条对话`}),v(),l({type:null})}}),N={deleteSingle:a=>l({type:"delete",conversations:[a]}),deleteBatch:a=>l({type:"delete",conversations:a}),close:()=>l({type:null})};return{conversations:w,totalCount:((y=c==null?void 0:c.pages[0])==null?void 0:y.count)||0,isLoading:C||j.isPending||d.isPending,error:b,hasNextPage:p,isFetchingNextPage:f,fetchNextPage:g,searchQuery:n,setSearchQuery:t,dialogState:i,dialogActions:N,deleteSingleConversation:j.mutate,deleteBatchConversations:d.mutate,loadMoreRef:D}}function ee(){const{dialogState:n,dialogActions:t,deleteSingleConversation:o,deleteBatchConversations:i,isLoading:l}=L();return{open:n.type,currentConversations:n.conversations||[],isLoading:l,openDeleteSingle:t.deleteSingle,openDeleteBatch:t.deleteBatch,closeDialog:t.close,handleDelete:()=>{n.conversations&&(n.conversations.length===1?o(n.conversations[0]):i(n.conversations))}}}const te=()=>{const n=R(),{conversations:t,totalCount:o,searchQuery:i,setSearchQuery:l,loadMoreRef:S,isLoading:c,hasNextPage:C,isFetchingNextPage:b,fetchNextPage:g}=L(),{open:p,currentConversations:f,openDeleteSingle:w,openDeleteBatch:D,closeDialog:v,handleDelete:j}=ee(),[d,N]=u.useState(new Set),[y,a]=u.useState(null),r=s=>{N(m=>{const h=new Set(m);return h.has(s)?h.delete(s):h.add(s),h})},z=()=>{N(new Set)},Q=()=>{const s=t.filter(m=>d.has(m.uuid));D(s)},E=s=>{n({to:`/chat?threadId=${s}`})},T=()=>{l("")};return e.jsxs(e.Fragment,{children:[e.jsxs(G,{fixed:!0,children:[e.jsx("h3",{className:"text-2xl font-bold",children:"对话记录"}),e.jsx("div",{className:"ml-auto flex items-center space-x-4"})]}),e.jsx(W,{children:e.jsxs("div",{className:"max-w-4xl mx-auto pt-0 px-6 pb-6",children:[e.jsx("div",{className:"mb-8",children:e.jsxs("div",{className:"relative",children:[e.jsx($,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),e.jsx(q,{className:"pl-8 h-10 bg-transparent",placeholder:"搜索对话标题或关键词...",value:i,onChange:s=>l(s.target.value)}),i&&e.jsx(x,{variant:"ghost",size:"sm",className:"absolute right-2 top-1/2 -translate-y-1/2 h-8 w-8 p-0 opacity-70 hover:opacity-100",onClick:T,disabled:c,children:e.jsx(A,{className:"h-4 w-4"})})]})}),!c&&e.jsx("div",{className:"mb-6 text-sm text-muted-foreground",children:o>0&&(i?e.jsxs(e.Fragment,{children:["找到 ",o,' 个匹配 "',i,'" 的对话']}):e.jsxs(e.Fragment,{children:["共 ",o," 个对话"]}))}),c&&t.length===0?e.jsxs("div",{className:"flex justify-center items-center py-12",children:[e.jsx(F,{className:"h-8 w-8 animate-spin"}),e.jsx("span",{className:"ml-2",children:"加载中..."})]}):t.length===0?e.jsx("div",{className:"text-center py-12",children:e.jsx("p",{className:"text-muted-foreground",children:i?`没有找到匹配 "${i}" 的对话`:"还没有对话记录"})}):e.jsxs("div",{className:"space-y-1",children:[t.map(s=>{const m=d.has(s.uuid),h=y===s.uuid,I=m||h;return e.jsxs("div",{className:"group flex items-center py-2.5 px-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 relative cursor-pointer",onMouseEnter:()=>a(s.uuid),onMouseLeave:()=>a(null),children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 z-10",children:e.jsx("div",{onClick:P=>{P.stopPropagation(),r(s.uuid)},className:"cursor-pointer",children:I?m?e.jsx(Z,{className:"h-5 w-5 text-primary"}):e.jsx(O,{className:"h-5 w-5 text-muted-foreground group-hover:text-primary ml-2"}):e.jsx("div",{className:"h-5 w-5"})})}),e.jsxs("div",{className:`flex-1 overflow-hidden transition-all duration-200 ${I?"ml-[25px]":""}`,onClick:()=>E(s.uuid),children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("div",{className:"text-base cursor-pointer hover:text-primary transition-colors",children:s.title||"未命名对话"}),h&&d.size===0&&e.jsx("div",{className:"flex items-center ml-2 mr-1",children:e.jsx(K,{className:"h-4 w-4 text-primary hover:text-primary/80 cursor-pointer",onClick:P=>{P.stopPropagation(),w(s)}})})]}),e.jsx("div",{children:e.jsx("span",{className:"text-xs text-muted-foreground flex-shrink-0  transition-opacity duration-200",children:new Date(s.created_at).toLocaleString()})})]})]},s.uuid)}),e.jsx("div",{ref:S,className:"mt-8 flex justify-center",children:b?e.jsxs("div",{className:"flex items-center gap-2 py-4",children:[e.jsx(F,{className:"h-5 w-5 animate-spin"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"加载更多..."})]}):C?e.jsx("div",{className:"py-4",children:e.jsx(x,{variant:"outline",onClick:()=>g(),className:"text-sm",children:i?"点击加载更多搜索结果":"点击加载更多"})}):t.length>0?e.jsx("div",{className:"py-4 text-center",children:e.jsx("span",{className:"text-sm text-muted-foreground",children:"已到底啦"})}):null})]}),d.size>0&&e.jsx("div",{className:"fixed bottom-5 left-1/2 -translate-x-1/2",children:e.jsxs("div",{className:"bg-background border border-border rounded-lg shadow-lg p-2 flex items-center space-x-4",children:[e.jsx(x,{variant:"ghost",onClick:z,className:"h-8 text-xs",children:"退出"}),e.jsxs("span",{className:"text-sm text-muted-foreground whitespace-nowrap",children:["已选择 ",d.size," 个对话"]}),e.jsx(x,{onClick:Q,variant:"default",className:"h-8 text-xs",children:"删除"})]})}),p==="delete"&&e.jsx("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg p-6 max-w-sm w-full",children:[e.jsxs("h2",{className:"text-lg font-semibold mb-4",children:["确认删除 ",f.length," 条对话？"]}),e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx(x,{variant:"ghost",onClick:v,children:"取消"}),e.jsx(x,{variant:"destructive",onClick:j,children:"删除"})]})]})})]})})]})},oe=V("/_authenticated/history/")({component:te});export{oe as Route};
