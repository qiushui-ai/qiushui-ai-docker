import{ap as m,r as y,u as j,b as T,aG as g}from"./index-C_oIiI4O.js";import{u as A,a as O}from"./use-infinite-scroll-BwChjD87.js";const E=9,B=o=>{const{sub_type:e,command:r,args:c,env:u,url:l,api_key:s,headers:d,timeout:a}=o;return e==="stdio"?{command:r||"",args:c?c.split(/\s+/).filter(Boolean):[],env:u||"",timeout:a||30}:e==="sse"?{url:l||"",api_key:s||"",headers:d||"",timeout:a||30}:e==="streamableHttp"?{url:l||"",api_key:s||"",headers:d||"",timeout:a||30}:{command:"",args:[],env:"",timeout:30}},G=async({pageParam:o=1,keyword:e,tool_type:r})=>{const c={page:o,rows:E,...(e==null?void 0:e.trim())&&{keyword:e.trim()},...r&&{tool_type:r}},{data:u}=await m.post("/tools/page",c);return{data:u.items,count:u.pagination.total}},Z=async o=>{const{data:e}=await m.post(`/tools/mcpinfo/${o}`);return{tool:e.tool_info,mcp_info:{tools:e.tools,resources:e.resources,prompts:e.prompts}}};function K(o,e){const[r,c]=y.useState(o);return y.useEffect(()=>{const u=setTimeout(()=>{c(o)},e);return()=>{clearTimeout(u)}},[o,e]),r}function V(){var F;const[o,e]=y.useState(""),[r,c]=y.useState(""),u=K(o,500),[l,s]=y.useState({type:null}),d=j(),{data:a,isLoading:I,error:N,fetchNextPage:S,hasNextPage:_,isFetchingNextPage:b}=A({queryKey:["tools-infinite",u,r],queryFn:({pageParam:t=1})=>G({pageParam:t,keyword:u,tool_type:r||void 0}),initialPageParam:1,getNextPageParam:(t,n)=>{if(t.data.length===E)return n.length+1},staleTime:5*60*1e3}),P=y.useMemo(()=>(a==null?void 0:a.pages.flatMap(t=>t.data))||[],[a]),{loadMoreRef:Q}=O({hasNextPage:_,isFetchingNextPage:b,fetchNextPage:S,threshold:200}),p=()=>{d.invalidateQueries({queryKey:["tools-infinite"]})},v=T({mutationFn:t=>m.post("/tools/create",t).then(n=>n.data),onSuccess:t=>{g({title:"创建成功",description:`工具 "${t.name}" 已创建`}),p(),s({type:null})}}),M=T({mutationFn:({uuid:t,data:n})=>m.post(`/tools/update/${t}`,n).then(i=>i.data),onSuccess:t=>{g({title:"更新成功",description:`工具 "${t.name}" 已更新`}),p(),s({type:null})}}),$=T({mutationFn:t=>m.post(`/tools/delete/${t.uuid}`).then(n=>n.data),onSuccess:(t,n)=>{g({title:"删除成功",description:`工具 "${n.name}" 已删除`}),p(),s({type:null})}}),q=T({mutationFn:({toolUuid:t,enable:n})=>m.post(`/tools/toggle-status/${t}`,{enable:n},{transformResponse:[i=>{try{return JSON.parse(i)}catch{return i}}]}),onSuccess:(t,{toolUuid:n,enable:i})=>{var x;const C=((x=P.find(f=>f.uuid===n))==null?void 0:x.name)||"工具";if(t&&typeof t=="object"&&"message"in t){const f=t.message;if(f.includes("失败")){let D=f;if(t.data&&typeof t.data=="object"&&"tool_info"in t.data){const h=t.data.tool_info;h&&h.error&&(D=`${f}
详情：${h.error}`)}g({title:i?"启用失败":"禁用失败",description:D,variant:"destructive"}),p();return}}g({title:i?"启用成功":"禁用成功",description:`工具 "${C}" 已${i?"启用":"禁用"}`}),p()},onError:t=>{let n="请稍后重试";if(t&&typeof t=="object"&&"message"in t)n=t.message;else if(t&&typeof t=="object"&&"response"in t){const i=t.response;i&&i.data&&i.data.message&&(n=i.data.message)}g({title:"操作失败",description:n,variant:"destructive"}),p(),console.error("Toggle status error:",t)}}),L={create:()=>s({type:"create"}),edit:t=>s({type:"edit",tool:t}),delete:t=>s({type:"delete",tool:t}),close:()=>s({type:null})};return{tools:P,totalCount:((F=a==null?void 0:a.pages[0])==null?void 0:F.count)||0,isLoading:I||v.isPending||M.isPending||$.isPending,error:N,hasNextPage:_,isFetchingNextPage:b,fetchNextPage:S,searchQuery:o,setSearchQuery:e,toolTypeFilter:r,setToolTypeFilter:c,dialogState:l,dialogActions:L,createTool:v.mutate,updateTool:M.mutate,deleteTool:$.mutate,toggleToolStatus:q.mutate,loadMoreRef:Q}}function k(){const{dialogState:o,dialogActions:e,createTool:r,updateTool:c,deleteTool:u,isLoading:l}=V();return{open:o.type,currentTool:o.tool,isLoading:l,openCreate:e.create,openEdit:e.edit,openDelete:e.delete,closeDialog:e.close,handleSubmit:s=>{const d=B(s),a={name:s.name,description:s.description,tool_type:s.tool_type,sub_type:s.sub_type,tags:s.tags,is_active:s.is_active,tool_conf:d};o.type==="create"?r(a):o.type==="edit"&&o.tool&&c({uuid:o.tool.uuid,data:a})},handleDelete:()=>{o.tool&&u(o.tool)}}}export{V as a,Z as g,k as u};
