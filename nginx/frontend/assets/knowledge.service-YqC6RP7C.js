import{r as l,u as Q,b as g,ap as d,aH as p}from"./index-CTPVv2qI.js";import{u as q,a as B}from"./use-infinite-scroll-BdHXd_Cp.js";const P=9,C=async({pageParam:t=1,keyword:n})=>{const i={page:t,rows:P,...(n==null?void 0:n.trim())&&{keyword:n.trim()}},{data:u}=await d.post("/knowledge/page",i);return{data:u.items,count:u.pagination.total}};function F(t,n){const[i,u]=l.useState(t);return l.useEffect(()=>{const a=setTimeout(()=>{u(t)},n);return()=>{clearTimeout(a)}},[t,n]),i}function L(){var K;const[t,n]=l.useState(""),i=F(t,500),[u,a]=l.useState({type:null}),r=Q(),{data:o,isLoading:D,error:k,fetchNextPage:m,hasNextPage:w,isFetchingNextPage:f}=q({queryKey:["knowledgeBases-infinite",i],queryFn:({pageParam:e=1})=>C({pageParam:e,keyword:i}),initialPageParam:1,getNextPageParam:(e,s)=>{if(e.data.length===P)return s.length+1},staleTime:5*60*1e3}),M=l.useMemo(()=>(o==null?void 0:o.pages.flatMap(e=>e.data))||[],[o]),{loadMoreRef:E}=B({hasNextPage:w,isFetchingNextPage:f,fetchNextPage:m,threshold:200}),c=()=>{r.invalidateQueries({queryKey:["knowledgeBases-infinite"]})},y=g({mutationFn:e=>d.post("/knowledge/create",e).then(s=>s.data),onSuccess:e=>{p({title:"创建成功",description:`知识库 "${e.name}" 已创建`}),c(),a({type:null})}}),h=g({mutationFn:({uuid:e,data:s})=>d.post(`/knowledge/update/${e}`,s).then(x=>x.data),onSuccess:e=>{p({title:"更新成功",description:`知识库 "${e.name}" 已更新`}),c(),a({type:null})}}),S=g({mutationFn:e=>d.post(`/knowledge/delete/${e.uuid}`).then(s=>s.data),onSuccess:(e,s)=>{p({title:"删除成功",description:`知识库 "${s.name}" 已删除`}),c(),a({type:null})}}),b={create:()=>a({type:"create"}),edit:e=>a({type:"edit",knowledge:e}),delete:e=>a({type:"delete",knowledge:e}),close:()=>a({type:null})};return{knowledgeBases:M,totalCount:((K=o==null?void 0:o.pages[0])==null?void 0:K.count)||0,isLoading:D||y.isPending||h.isPending||S.isPending,error:k,hasNextPage:w,isFetchingNextPage:f,fetchNextPage:m,searchQuery:t,setSearchQuery:n,dialogState:u,dialogActions:b,createKnowledge:y.mutate,updateKnowledge:h.mutate,deleteKnowledge:S.mutate,loadMoreRef:E}}function I(){const{dialogState:t,dialogActions:n,createKnowledge:i,updateKnowledge:u,deleteKnowledge:a,isLoading:r}=L();return{open:t.type,currentKnowledge:t.knowledge,isLoading:r,openCreate:n.create,openEdit:n.edit,openDelete:n.delete,closeDialog:n.close,handleSubmit:o=>{t.type==="create"?i(o):t.type==="edit"&&t.knowledge&&u({uuid:t.knowledge.uuid,data:o})},handleDelete:()=>{t.knowledge&&a(t.knowledge)}}}export{L as a,I as u};
