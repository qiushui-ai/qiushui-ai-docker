# Nginx配置 - 秋水AI项目

# 上游服务器定义
upstream backend_upstream {
    server backend:16009;
}

upstream agents_upstream {
    server agents:16001;
}

# 主服务器配置
server {
    listen 80;
    server_name _;

    # 日志配置
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log warn;

    # 客户端请求体大小限制 (用于文件上传)
    client_max_body_size 100M;

    # 超时配置
    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;

    # 前端静态文件
    location / {
        root /usr/share/nginx/html;
        index index.html;
        try_files $uri $uri/ /index.html;

        # 缓存配置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # Backend API 代理
    location /api/v1/ {
        proxy_pass http://backend_upstream;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 缓冲设置
        proxy_buffering off;
    }

    # Agents API 代理
    location /qagent {
        # 使用 /agent/ 前缀代理到agents服务
        proxy_pass http://agents_upstream;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # 流式响应/SSE 专用配置
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 24h;        # 增加到24小时，支持长连接
        proxy_send_timeout 24h;        # 增加到24小时
        proxy_connect_timeout 60s;     # 连接超时保持60秒
        
        # 禁用 Nginx 的缓冲，确保流式数据实时传输
        proxy_request_buffering off;
        
        # SSE 需要的头部设置
        add_header Cache-Control "no-cache";
        add_header X-Accel-Buffering "no";
    }

    # 健康检查端点
    location /nginx-health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
